---
editor_options:
  chunk_output_type: console
---

# Data

NOTES:

-   The R code chunks below are *not* included in the [source package](https://r-pkgs.org/package-structure-state.html#source-package) (`purl = FALSE`). The
    chunks have to be executed at least once to generate the necessary internal data file [`R/sysdata.rda`](https://r-pkgs.org/data.html#data-sysdata).

-   Although the datasets below are saved as "internal data" in `R/sysdata.rda`, some of them are still exported and documented (in the main `.Rmd` document),
    something [not explicitly mentioned](https://coolbutuseless.github.io/2018/12/10/r-packages-internal-and-external-data/) in the book [R
    Packages](https://r-pkgs.org/data.html#data-data) (and maybe a CRAN violation?).

## `ballot_dates`

FOKUS-covered ballot dates

```{r, purl = FALSE}
ballot_dates <-
  fs::dir_ls(path = "data-raw/questionnaire",
             type = "file",
             regexp = "/\\d{4}-\\d{2}-\\d{2}\\.toml$") %>%
  stringr::str_extract(pattern = "\\d{4}-\\d{2}-\\d{2}(?=\\.toml$)")
```

## `raw_q`

Raw questionnaire data as a structured list

```{r, purl = FALSE}
raw_q <- fokus::read_toml("data-raw/questionnaire/questionnaire.toml")
```

## `raw_qx_suppl`

Raw supplemental date-specific questionnaire data as a structured list

```{r, purl = FALSE}
raw_qx_suppl <-
  ballot_dates %>%
  magrittr::set_names(., .) %>%
  purrr::map(~ fokus::read_toml(glue::glue("data-raw/questionnaire/{.x}.toml")))
```

## `ballot_metadata`

FOKUS ballot-date-canton metadata

```{r, purl = FALSE}
ballot_metadata <-
  raw_qx_suppl %>%
  purrr::map_dfr(function(raw_q_suppl) {
    
    tibble::tibble(ballot_date = raw_q_suppl$ballot_date,
                   canton = unique(names(raw_q_suppl$cantonal))) %>%
      dplyr::mutate(n_cantonal_proposals = canton %>% purrr::map_int(~ length(raw_q_suppl$cantonal[[.x]]$proposal)),
                    n_cantonal_proportional_elections = canton %>% purrr::map_int(~ length(raw_q_suppl$cantonal[[.x]]$election$proportional)),
                    n_cantonal_majoritarian_elections = canton %>% purrr::map_int(~ length(raw_q_suppl$cantonal[[.x]]$election$majoritarian)),
                    n_federal_proposals = length(raw_q_suppl$federal$proposal),
                    n_federal_proportional_elections = canton %>% purrr::map_int(~ length(raw_q_suppl$federal[[.x]]$election$proportional)),
                    n_federal_majoritarian_elections = canton %>% purrr::map_int(~ length(raw_q_suppl$federal[[.x]]$election$majoritarian)))
  })
```

## `cantons`

FOKUS-covered cantons

```{r, purl = FALSE}
cantons <- unique(ballot_metadata$canton)
```

## `proposal_types`

NOTES:

-   counterproposals types are explained e.g.
    [here](https://www.ch.ch/de/demokratie/politische-rechte/volksinitiative/was-ist-ein-direkter-gegenentwurf-was-ein-indirekter-gegenvo/)

```{r, purl = FALSE}
proposal_types <- c("citizens' initiative",
                    "direct counterproposal",
                    "indirect counterproposal",
                    "mandatory referendum",
                    "optional referendum")
```

## `response_option_types`

Response option types defined in the raw FOKUS questionnaire data

```{r, purl = FALSE}
response_option_types <- names(raw_q$response_options)
```

## `q_item_keys`

Questionnaire item keys supported in the raw FOKUS questionnaire data

```{r, purl = FALSE}
q_item_keys <- tibble::tribble(
  
  ~key,                         ~is_scalar, ~is_iterator, ~type,
  "lvl",                        FALSE,      TRUE,        "character",
  "i",                          FALSE,      TRUE,        "character",
  "j",                          FALSE,      TRUE,        "character",
  "block",                      TRUE,       FALSE,       "character",
  "variable_name",              TRUE,       FALSE,       "character",
  "who",                        TRUE,       FALSE,       "character",
  "topic",                      TRUE,       FALSE,       "character",
  "question",                   TRUE,       FALSE,       "character",
  "question_common",            TRUE,       FALSE,       "character",
  "variable_label",             TRUE,       FALSE,       "character",
  "variable_label_common",      TRUE,       FALSE,       "character",
  "response_options",           FALSE,      FALSE,       "character",
  "variable_values",            FALSE,      FALSE,       "integer",
  "value_labels",               FALSE,      FALSE,       "character",
  "value_scale",                TRUE,       FALSE,       "character",
  "multiple_answers_allowed",   TRUE,       FALSE,       "logical",
  "randomize_response_options", TRUE,       FALSE,       "logical",
  "ballot_types",               FALSE,      FALSE,       "character",
  "include",                    TRUE,       FALSE,       "logical"
)
```

## `q_non_item_lvls`

```{r, purl = FALSE}
q_non_item_lvls <- c("title",
                     "who",
                     "party",
                     "response_options",
                     "footnote",
                     "link")
```

## `q_ballot_types`

```{r, purl = FALSE}
q_ballot_types <- c("referendum",
                    "election",
                    "both_referendum_and_election")
```

## `shortening_rules`

Variable name shortening rules

The rules will be applied one by one in the order they are listed below by `shorten_v_names()`.

```{r, purl = FALSE}
shortening_rules <- tibble::tribble(
  
  ~string,                                   ~replacement,                   ~allowed,
  
  # sophisticated rules
  "cantonal_government_parliament",          "cgovparl",                     "begin-middle-end",
  "cantonal_government",                     "cgov",                         "begin-middle-end",
  "cantonal_parliament",                     "cparl",                        "begin-middle-end",
  "cantonal_proposals",                      "cps",                          "begin-middle-end",
  "cantonal_proposal",                       "cp",                           "begin-middle-end",
  "federal_proposals",                       "fps",                          "begin-middle-end",
  "federal_proposal",                        "fp",                           "begin-middle-end",
  "cantonal_proportional_elections",         "cpes",                         "begin-middle-end",
  "cantonal_proportional_election",          "cpe",                          "begin-middle-end",
  "federal_proportional_elections",          "fpes",                         "begin-middle-end",
  "federal_proportional_election",           "fpe",                          "begin-middle-end",
  "cantonal_majoritarian_elections",         "cmes",                         "begin-middle-end",
  "cantonal_majoritarian_election",          "cme",                          "begin-middle-end",
  "federal_majoritarian_elections",          "fmes",                         "begin-middle-end",
  "federal_majoritarian_election",           "fme",                          "begin-middle-end",
  "cantonal_elections",                      "ces",                          "begin-middle-end",
  "cantonal_election",                       "ce",                           "begin-middle-end",
  "federal_elections",                       "fes",                          "begin-middle-end",
  "federal_election",                        "fe",                           "begin-middle-end",
  "cantonal",                                "c",                            "begin-middle-end",
  "federal",                                 "f",                            "begin-middle-end",
  "time",                                    "t",                            "begin",
  "other",                                   "o",                            "end",
  "reduced",                                 "rdc",                          "end",
  
  # simple rules
  "applications",                            "apps",                         "begin-middle-end",
  "agglomeration",                           "agglo",                        "begin-middle-end",
  "attitude",                                "att",                          "begin-middle-end",
  "booklet",                                 "bkl",                          "begin-middle-end",
  "candidate",                               "cand",                         "begin-middle-end",
  "competent",                               "cmp",                          "begin-middle-end",
  "convincing",                              "cnv",                          "begin-middle-end",
  "custom",                                  "cm",                           "begin-middle-end",
  "decision",                                "dcsn",                         "begin-middle-end",
  "hypothetical",                            "hypo",                         "begin-middle-end",
  "importance",                              "imp",                          "begin-middle-end",
  "ineffectiveness",                         "ineff",                        "begin-middle-end",
  "information_source",                      "info_src",                     "begin-middle-end",
  "infrastructure",                          "infra",                        "begin-middle-end",
  "insurance",                               "insrnc",                       "begin-middle-end",
  "modification",                            "mod",                          "begin-middle-end",
  "options",                                 "opts",                         "begin-middle-end",
  "political",                               "pol",                          "begin-middle-end",
  "positioning",                             "pos",                          "begin-middle-end",
  "reduction",                               "red",                          "begin-middle-end",
  "spending",                                "spend",                        "begin-middle-end",
  "switzerland",                             "ch",                           "begin-middle-end",
  "typology",                                "typ",                          "begin-middle-end",
  
  # lazy rules
  "reason_non_participation",                "reason_non_part",              "begin-middle-end",
  "weight_participation",                    "weight_prt",                   "begin-middle-end",
  "equivalised_income",                      "equi_inc",                     "begin-middle-end",
  "environmentalism_vs_economic_prosperity", "env_vs_econ",                  "begin-middle-end",
  "welfare_state_vs_self_responsibility",    "welfare_vs_self_respon",       "begin-middle-end",
  "equal_opportunity_foreigners",            "equal_opportunity_foreign",    "begin-middle-end"
)
```

## `fokus_private_structure`

Expected structure for the `fokus_private` directory/repository

TODO: convert to pretty textual dir structure

```{r, purl = FALSE}
fokus_private_structure <-
  list("fokus_private/" =
         list("bibliography/" = list("zotero_c2d.bib",
                                     "zotero_c2d.json"),
              "bin/" = list("pandoc/" = list("linux/",
                                             "macos/",
                                             "windows/")),
              "config/" = list("csl/",
                               "css/",
                               "shared_pandoc_variables/" = list("online_de.yaml",
                                                                 "online_en.yaml",
                                                                 "print_de.yaml",
                                                                 "print_en.yaml"),
                               "config.toml",
                               "output.yaml",
                               "pandoc_template.tex",
                               "shared_header-includes.tex",
                               "..."),
              "data/" = list("[CANTON]/" = list("easyvote_municipalities_[BALLOT_DATE].csv",
                                                "online_participation_codes_[BALLOT_DATE].txt",
                                                "survey_data_[BALLOT_DATE].xlsx",
                                                "survey_data_[BALLOT_DATE]_*.xlsx",
                                                "survey_data_preliminary_[BALLOT_DATE].xlsx",
                                                "voting_register_data_extra_[STATOFF_DELIVERY_DATE].xlsx",
                                                "voting_register_ids_[BALLOT_DATE].csv",
                                                "...")),
              "fonts/" = list("..."),
              "images/" = list("[CANTON]/" = list("[BALLOT_DATE]"),
                               "..."),
              "print_docs/" = list("questionnaire_print_[BALLOT_DATE]_[CANTON].pdf"),
              "rmd/" = list("snippets/" = list("[CANTON]/" = list("[BALLOT_DATE]_cantonal_proposal_#.Rmd",
                                                                  "[BALLOT_DATE]_opinion_formation_and_participation.Rmd",
                                                                  "[BALLOT_DATE]_special_*.Rmd",
                                                                  "[BALLOT_DATE]_special_*_summary.Rmd",
                                                                  "[BALLOT_DATE]_summary.Rmd"),
                                               "imprint_de.Rmd",
                                               "imprint_en.Rmd",
                                               "methodological_description.Rmd"),
                            "data_overview.Rmd",
                            "questionnaire.Rmd",
                            "paper_[BALLOT_DATE]_[CANTON].Rmd",
                            "report_[BALLOT_DATE]_[CANTON].Rmd",
                            "report_cantonal_majoritarian_[BALLOT_DATE]_[CANTON].Rmd",
                            "report_cantonal_proportional_[BALLOT_DATE]_[CANTON].Rmd",
                            "report_federal_majoritarian_[BALLOT_DATE]_[CANTON].Rmd",
                            "report_federal_proportional_[BALLOT_DATE]_[CANTON].Rmd",
                            "special_*_[BALLOT_DATE]_[CANTON].Rmd"),
              "output/" = list("data/" = list("internal/" = list("r/",
                                                                 "spss/",
                                                                 "stata/"),
                                              "public/",
                                              "publitest/"),
                               "images/" = list("[BALLOT_DATE]/" = list("[CANTON]/" = list("...")),
                                                "qr_codes/" = list("[BALLOT_DATE]_[CANTON].zip")),
                               "questionnaires/" = list("questionnaire_[BALLOT_DATE]_[CANTON].csv",
                                                        "questionnaire_[BALLOT_DATE]_[CANTON].html",
                                                        "questionnaire_[BALLOT_DATE]_[CANTON].md",
                                                        "questionnaire_[BALLOT_DATE]_[CANTON].xlsx"),
                               "publications/" = list("libs/",
                                                      "..."),
                               "rmd/" = list("[BALLOT_DATE]/" = list("[CANTON]/" = list("plots/")))),
              "README.Rmd",
              "...")
  )
```

```{r, purl = FALSE}
fokus_private_structure <- readr::read_file(file = "data-raw/snippets/fokus_private_structure.md")
```

## Write package-internal data

Save all the internal data objects to `R/sysdata.rda`.

```{r, purl = FALSE}
usethis::use_data(ballot_dates,
                  raw_q,
                  raw_qx_suppl,
                  ballot_metadata,
                  cantons,
                  proposal_types,
                  response_option_types,
                  q_item_keys,
                  q_non_item_lvls,
                  q_ballot_types,
                  shortening_rules,
                  fokus_private_structure,
                  internal = TRUE,
                  overwrite = TRUE,
                  compress = "xz",
                  version = 3L)
```
