---
editor_options:
  chunk_output_type: console
---

# NOTES

-   This file is *not* included in the [source package](https://r-pkgs.org/structure.html#sec-source-package) because of the [`.nopurl` suffix in its
    filename](https://pkgpurl.rpkg.dev/reference/purl_rmd.html#-rmd-files-excluded-from-purling).

-   The chunks below have to be manually executed in order to regenerate the package data.

-   When used internally, other than internal data, [exported data](https://r-pkgs.org/data.html#sec-data-data) must always be referred to by its explicit
    namespace.

# Setup

```{r}
library(rlang,
        include.only = c("%|%", "%||%"))
library(magrittr,
        include.only = c("%>%", "%<>%", "%T>%", "%!>%", "%$%"))
```

# Define data

## `qstnrs`

Questionnaire data as one single long-format tibble. We also export the qstnrs in all relevant formats to this repository's `output/questionnaires` directory,
which is automatically deployed to [qstnr.fokus.ag](https://qstnr.fokus.ag/) via Netlify.

```{r}
qstnrs <-
  fokus::all_ballot_dates %>%
  magrittr::set_names(., .) |>
  purrr::map(fokus::cantons) |>
  purrr::imap(\(cantons, ballot_date) {
    
    cantons |>
      purrr::map(\(canton) {
        
        qstnr_tibble <-
          fokus:::gen_qstnr_tibble(ballot_date = ballot_date,
                                   canton = canton) |>
          fokus:::validate_qstnr_tibble()
        
        fokus::export_qstnr(qstnr_tibble = qstnr_tibble,
                            path = "output/questionnaires",
                            upload_to_g_drive = FALSE)
        qstnr_tibble
      }) |>
      purrr::list_rbind()
  }) |>
  purrr::list_rbind() |>
  # expand list cols
  tidyr::unnest(cols = any_of(fokus:::qstnr_item_keys_multival)) |>
  # modify some vars
  dplyr::mutate(
    ## complete `question_full`
    question_full = question_full %|% question,
    ## merge `question_intro_i/j` into `question_intro`
    question_intro = paste(tidyr::replace_na(data = question_intro_i,
                                             replace = ""),
                           tidyr::replace_na(data = question_intro_j,
                                             replace = "")),
    ## complete `*_common` vars with their ballot-date/canton-specific siblings
    question_common = question_common %|% question_full,
    variable_label_common = variable_label_common %|% variable_label) |>
  dplyr::select(-c(question_intro_i,
                   question_intro_j,
                   lvl,
                   i,
                   j)) |>
  dplyr::relocate(question_intro,
                  .before = question) |>
  # strip Markdown formatting from chr cols
  dplyr::mutate(dplyr::across(where(is.character),
                              pal::strip_md))
```

## `proposals`

```{r}
proposals <- 
  fokus::all_ballot_dates |>
  purrr::map(\(ballot_date) {
    
    fokus::cantons(ballot_date) |>
      purrr::map(\(canton) {
        
        fokus::combos_proposals(ballot_date = ballot_date,
                                canton = canton) |>
          purrr::map(\(combo) {
            
            tibble::tibble(ballot_date = ballot_date,
                           lvl = combo$lvl,
                           canton = canton,
                           nr = combo$proposal_nr,
                           type = fokus::proposal_type(ballot_date = ballot_date,
                                                       lvl = lvl,
                                                       canton = canton,
                                                       proposal_nr = nr),
                           name.de.short = fokus::proposal_name(ballot_date = ballot_date,
                                                                lvl = lvl,
                                                                canton = canton,
                                                                proposal_nr = nr,
                                                                type = "short"),
                           name.de.long = fokus::proposal_name(ballot_date = ballot_date,
                                                               lvl = lvl,
                                                               canton = canton,
                                                               proposal_nr = nr,
                                                               type = "long"))
          }) |>
          purrr::list_rbind()
      }) |>
      purrr::list_rbind()
  }) |>
  purrr::list_rbind()
```

## `elections`

```{r}
elections <- 
  fokus::all_ballot_dates |>
  purrr::map(\(ballot_date) {
    
    fokus::cantons(ballot_date) |>
      purrr::map(\(canton) {
                   
        fokus::combos_elections(ballot_date = ballot_date,
                                canton = canton) |>
          purrr::map(\(combo) {
            
            tibble::tibble(ballot_date = ballot_date,
                           lvl = combo$lvl,
                           canton = canton,
                           prcd = combo$prcd,
                           nr = combo$election_nr,
                           name.de.short = fokus::election_name(ballot_date = ballot_date,
                                                                lvl = lvl,
                                                                canton = canton,
                                                                prcd = prcd,
                                                                election_nr = nr,
                                                                type = "short"),
                           name.de.long = fokus::election_name(ballot_date = ballot_date,
                                                               lvl = lvl,
                                                               canton = canton,
                                                               prcd = prcd,
                                                               election_nr = nr,
                                                               type = "long"),
                           name.de.body = fokus::election_name(ballot_date = ballot_date,
                                                               lvl = lvl,
                                                               canton = canton,
                                                               prcd = prcd,
                                                               election_nr = nr,
                                                               type = "body"))
          }) |>
          purrr::list_rbind()
      }) |>
      purrr::list_rbind()
  }) |>
  purrr::list_rbind()
```

# Write data

Save all the bigger data objects to separate files under `data/*.rda`. Note that when documenting them, they mustn't be explicitly `@export`ed since they're
already automatically exported and thus available to package users.

```{r}
usethis::use_data(qstnrs,
                  proposals,
                  elections,
                  internal = FALSE,
                  overwrite = TRUE,
                  compress = "xz",
                  version = 3L)
```
